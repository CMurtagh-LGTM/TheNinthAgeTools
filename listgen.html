<!DOCTYPE html>
<head>
<link rel="stylesheet" type="text/css" href="listgen.css">
<script type="module">
  function c_string(memory_buffer, offset, size) {
    const buffer = new Int8Array(memory_buffer, offset, size);
    let string = "";
    for (let i = 0; i < size; ++i) {
      string += String.fromCharCode(buffer[i]);
    }
    return string;
  }

  async function init() {
    let memory_buffer;
    const { instance } = await WebAssembly.instantiateStreaming(
      fetch("./build_wasm/listgen.wasm"),
      {
        env: {
          log(offset, size) { console.log(c_string(memory_buffer, offset, size)); },
        },
        dom: {
          get_by_id(offset, size) { return document.getElementById(c_string(memory_buffer, offset, size)) },
          set_text(node, offset, size) {
            node.textContent = c_string(memory_buffer, offset, size);
          },
          set_id(node, offset, size) {
            node.id = c_string(memory_buffer, offset, size);
          },
          add_class(node, offset, size) {
            node.classList.add(c_string(memory_buffer, offset, size));
          },
          append_child(node_parent, offset, size) {
            let node = document.createElement(c_string(memory_buffer, offset, size));
            node_parent.appendChild(node);
            return node;
          },
          set_img_src(img, offset, size) {
            img.src = c_string(memory_buffer, offset, size);
          },
          set_popover(node) {
            node.popover = "auto";
          },
          set_popover_target(node, popover) {
            node.popoverTargetElement = popover;
          },
        },
        wasi_snapshot_preview1: {
          environ_get (arg1, arg2) {},
          environ_sizes_get (arg1, arg2) {},
          fd_close(arg) {},
          fd_prestat_get(arg1, arg2) {},
          fd_prestat_dir_name(arg1, arg2, arg3) {},
          fd_seek(arg1, arg2, arg3, arg4) {},
          fd_write(arg1, arg2, arg3, arg4) {},
          proc_exit(arg) {},
        },
      },
      {
        builtins: ["js-string"],
      },
    );

    memory_buffer = instance.exports.memory.buffer;
    instance.exports._start();
  }
  init();
</script>
</head>
<body>
<div id="content"/>
</body>
